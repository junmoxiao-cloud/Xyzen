name: Sync Base Images

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAMESPACE: scienceol

permissions:
  packages: write

jobs:
  sync-images:
    name: Sync ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include:
          # Alpine
          - source: docker.io/library/alpine:3.22
            target: alpine:3.22
          # Node
          - source: docker.io/library/node:24-alpine
            target: node:24-alpine
          # Python
          - source: docker.io/library/python:3.13.5-slim
            target: python:3.13.5-slim
          # PostgreSQL
          - source: docker.io/library/postgres:16.8-alpine
            target: postgres:16.8-alpine
          # Redis
          - source: docker.io/library/redis:7.4.2-alpine
            target: redis:7.4.2-alpine
          # MinIO
          - source: docker.io/minio/minio:RELEASE.2025-04-22T22-12-26Z
            target: minio:RELEASE.2025-04-22T22-12-26Z
          # Casdoor
          - source: docker.io/casbin/casdoor:2.285.0
            target: casdoor:2.285.0

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.SCIENCEOL_GITHUB_TOKEN }}

      - name: Check and Sync ${{ matrix.target }}
        run: |
          SOURCE="${{ matrix.source }}"
          TARGET="${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ matrix.target }}"

          echo "Checking if $TARGET already exists..."

          # Check if target image already exists in GHCR
          if docker buildx imagetools inspect "$TARGET" > /dev/null 2>&1; then
            echo "âœ… Image already exists: $TARGET"
            echo "Skipping sync."
            exit 0
          fi

          echo "Image not found, syncing $SOURCE -> $TARGET"

          # Retry up to 3 times with delay
          for i in 1 2 3; do
            if docker buildx imagetools create --tag "$TARGET" "$SOURCE"; then
              echo "âœ… Synced: $TARGET"
              exit 0
            fi
            echo "Attempt $i failed, waiting 30s before retry..."
            sleep 30
          done

          echo "âŒ Failed to sync after 3 attempts"
          exit 1

  summary:
    name: Summary
    needs: sync-images
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Job summary
        run: |
          echo "## ðŸ“¦ Base Images Synced to ghcr.io/scienceol" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/scienceol/node:24-alpine" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/scienceol/python:3.13.5-slim" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/scienceol/alpine:3.22" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/scienceol/postgres:16.8-alpine" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/scienceol/redis:7.4.2-alpine" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/scienceol/minio:RELEASE.2025-04-22T22-12-26Z" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/scienceol/casdoor:v2.43.0" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
